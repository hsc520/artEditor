!function(t){t.fn.ajaxfileupload=function(e){var i={params:{},action:"",sizes:5120,onStart:function(){console.log("starting upload"),console.log(this)},onComplete:function(t){console.log("got response: "),console.log(t),console.log(this)},onCancel:function(){console.log("cancelling: "),console.log(this)},validate_extensions:!0,valid_extensions:["gif","png","jpg","jpeg","bmp"],submit_button:null},o=!1;return e&&t.extend(i,e),this.each(function(){var e=t(this);if(e.data("ajaxUploader-setup")!==!0){e.change(function(){o=!1,i.submit_button||n()}),i.submit_button&&i.submit_button.click(function(t){t.preventDefault(),o||n()});var n=function(){if(""===e.val())return i.onCancel.apply(e,[i.params]);var n=/msie/i.test(navigator.userAgent)&&!window.opera;if(n&&!e[0].files){var a=e[0].value,r=new ActiveXObject("Scripting.FileSystemObject");if(!r.FileExists(a))return i.onComplete.apply(e,[{hasError:!0,message:"附件不存在，请重新输入！"},i.params]),!1;var l=r.GetFile(a);fileSize=l.Size}else fileSize=e[0].files[0].size;var d=fileSize/1024;if(d>i.sizes)return i.onComplete.apply(e,[{hasError:!0,message:"附件大小不能大于"+i.sizes/1024+"M！"},i.params]),e[0].value="",!1;if(d<=0)return i.onComplete.apply(e,[{hasError:!0,message:"附件大小不能为0M！"},i.params]),e[0].value="",!1;var c=e.val().split(".").pop().toLowerCase();if(!0===i.validate_extensions&&t.inArray(c,i.valid_extensions)===-1)i.onComplete.apply(e,[{status:!1,message:"文件类型错误，只支持 "+i.valid_extensions.join(", ")+" 格式的文件。"},i.params]);else{o=!0,s(e);var p=i.onStart.apply(e,[i.params]);p!==!1&&e.parent("form").submit(function(t){t.stopPropagation()}).submit()}};e.data("ajaxUploader-setup",!0);var a=function(t,e){var n,a=t.contentWindow.document.body.innerText||t.contentWindow.document.body.textContent;try{n=JSON.parse(a)}catch(t){n=a}e.siblings().remove(),e.unwrap(),o=!1,i.onComplete.apply(e,[n,i.params])},s=function(e){var o="ajaxUploader-iframe-"+Math.round((new Date).getTime()/1e3);t("body").after('<iframe width="0" height="0" style="display:none;" name="'+o+'" id="'+o+'"/>'),t("#"+o).load(function(){a(this,e)}),e.wrap(function(){return'<form action="'+i.action+'" method="POST" enctype="multipart/form-data" target="'+o+'" />'}).before(function(){var t,e="";for(t in i.params){var o=i.params[t];"function"==typeof o&&(o=o()),e+='<input type="hidden" name="'+t+'" value="'+o+'" />'}return e})}}})}}(jQuery);var addEvent=function(){return document.addEventListener?function(t,e,i){t.addEventListener(e,i,!1)}:function(t,e,i){t.attachEvent("on"+e,function(){return i.call(t,window.event)})}}();!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define(e):this[t]=e()}("editor",function(){"use strict";function t(t,e,i){this._container="#"+t,this.options=i||{},this.init(e),this._editorId=e}return t.prototype.init=function(t){var e='<div class="g-editor-container"><div class="header"><div class="type"><div class="item undo" command="undo"><i class="undo-icon"></i>撤销</div><div class="item redo" command="redo"><i class="redo-icon"></i>重做</div></div><div class="type"><div class="item bold" style="position:relative;" command="bold"><i class="bold-icon"></i>加粗<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div><div class="item italic" style="position:relative;" command="italic"><i class="italic-icon"></i>斜体<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div></div><div class="type"><div class="item image" style="position:relative;"><i class="image-icon"></i>插入图片<input type="file" name="upload_file" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div></div><div class="type"><div class="item title" style="position:relative;" command="formatBlock", params="<H2>"><i class="title-icon"></i>二级标题<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div></div><div class="type"><div class="item left" style="position:relative;" command="justifyleft"><i class="left-icon"></i>左对齐<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div><div class="item center" style="position:relative;" command="justifycenter"><i class="center-icon"></i>居中<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div><div class="item right" style="position:relative;" command="justifyright"><i class="right-icon"></i>右对齐<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div><div class="item justify" style="position:relative;" command="justifyFull"><i class="justify-icon"></i>两端对齐<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div></div><div class="type"><div class="item more" style="position:relative;" command="indent"><i class="more-icon"></i>增加缩进<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div><div class="item less" style="position:relative;" command="outdent"><i class="less-icon"></i>减少缩进<input type="button" style="position: absolute;left: 0;top: 0;width: 100%;height:100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);"></div></div><div class="type" style="position:relative;"><div class="item link" command=""><i class="link-icon"></i>插入链接</div><div class="item empty" command=""><i class="clear-icon"></i>清除</div><div class="link-content"><i class="arrow-top"></i><i class="arrow-bottom"></i><div class="link-title">引用已有参考资料</div><div class="link-item-content"></div></div></div></div><div class="editor-contains"><iframe id="'+t+'" class="editor" frameborder="0"></iframe> </div></div>';$(this._container).html(e),this._editor=document.getElementById(t).contentWindow,this._editor.document.designMode="on",this._editor.document.contentEditable=!0,this._editor.document.open(),this._editor.document.write('<head><style type="text/css">body{font-family:"Hiragino Sans GB", "Microsoft YaHei","微软雅黑", "宋体", Arial,Verdana, sans-serif;font-size:14px;word-wrap: break-word;}.link-flag {position:relative;color:#666666;cursor:pointer;overflow:hidden;}.link-tips {display: none;position: absolute;left: -23px;background: #fff;border: 1px solid #ccc;padding: 20px;top: 25px;white-space: nowrap;z-index:9;}.arrow-top {position:absolute;width:0;height:0;border-color:transparent transparent #cccccc transparent;border-style:dashed dashed solid dashed;border-width:10px;top:-21px;}.arrow-bottom {position:absolute;width:0;height:0;border-color:transparent transparent #f6f6f6 transparent;border-style:dashed dashed solid dashed;border-width:10px;top:-20px;}.upload-img{max-width: 180px;max-height:120px}.placeholder{color:#cccccc;}</style></head><body>'+this.options.placeholder+"</body>"),this._editor.document.close(),this.initHandler();var i=this,o="";this._editor.document.onmouseup=function(){i._editor.getSelection&&i._editor.getSelection().toString().length>=1?$(".undo,.redo,.bold,.italic,.image,.title,.link,.empty",i._container).addClass("on"):!i._editor.getSelection&&i._editor.document.selection.createRange().text?$(".bold,.italic",i._container).addClass("on"):$(".bold,.italic",i._container).removeClass("on")},addEvent(this._editor,"focus",function(){$(".undo,.redo,.image,.title,.left,.center,.justify,.center,.right,.more,.less,.link,.empty",i._container).addClass("on"),$.trim($(i._editor.document.body).html())===i.options.placeholder&&$(i._editor.document.body).html("")}),addEvent(this._editor,"paste",function(t){var e=i._editor.getSelection?i._editor.getSelection():i._editor.document.selection;o=e.createRange?e.createRange():e.getRangeAt(0);var n=$(i._editor.document),a='<textarea class="paste-content" style="width: 0px;height: 0px;opacity: 0;filter:alpha(opacity=0);resize: none;"></textarea>';n.find("body").append(a);var s=n.find(".paste-content");s.focus(),setTimeout(function(){var t=s.val();s.remove(),$(i._editor.document.body).trigger("focus");var e=i._editor.getSelection?i._editor.getSelection():i._editor.document.selection,n=e.createRange?e.createRange():e.getRangeAt(0);if(o&&(n=o),i._editor.getSelection){n.collapse(!1);for(var a=n.createContextualFragment(t),r=a.lastChild;r&&"br"==r.nodeName.toLowerCase()&&r.previousSibling&&"br"==r.previousSibling.nodeName.toLowerCase();){var l=r;r=r.previousSibling,a.removeChild(l)}n.insertNode(a),r&&(n.setEndAfter(r),n.setStartAfter(r)),e.removeAllRanges(),e.addRange(n)}else n.pasteHTML(t),n.select()},0)}),addEvent(this._editor,"blur",function(){$.trim($(i._editor.document.body).html())||$(i._editor.document.body).html(i.options.placeholder),i._editor.getSelection&&i._editor.getSelection().toString().length>=1||!i._editor.getSelection&&i._editor.document.selection.createRange().text||$(".undo,.redo,.bold,.italic,.image,.title,.left,.center,.justify,.center,.right,.more,.less,.link,.empty",i._container).removeClass("on")})},t.prototype.setFocus=function(){var t=this,e=t._editor.document.body;if($(t._editor.document.body).trigger("focus"),$.trim(e.innerHTML)&&t._editor.document.getSelection){var i=t._editor.getSelection?t._editor.getSelection():t._editor.document.selection,o=i.createRange?i.createRange():i.getRangeAt(0);t._editor.getSelection?(o.setStartAfter(e.lastChild,0),i.removeAllRanges(),i.addRange(o)):o.select()}},t.prototype.initHandler=function(){var t=this;$(this._container).find(".item").click(function(){var e=this.getAttribute("command"),i=this.getAttribute("params");e&&(t._editor.document.execCommand(e,!1,i),t._editor.focus())}),$(t._container).find('input[type="file"]').ajaxfileupload({valid_extensions:["gif","png","jpg","jpeg","bmp"],action:t.options.imageUpload,onStart:function(){},onComplete:function(e){if(e&&e.status===!1)return alert(e.message),void $(t._container).find('input[type="file"]').val("");if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return alert("抱歉，上传失败。"),void $(t._container).find('input[type="file"]').val("")}if(!e||e.hasError)return alert(e&&e.message||"抱歉，上传失败。"),void $(t._container).find('input[type="file"]').val("");var i='<img class="upload-img" src="'+e.map.accessDomain+e.map.filePath+'" />';t.insertImage(i),$.browser.msie?($(t._container).find('input[type="file"]').replaceWith('<input type="file" style="position: absolute;left: 0;top: 0;width: 100%;bottom: 0;opacity: 0;filter:alpha(opacity=0);">'),t.uploadCore()):$(t._container).find('input[type="file"]').val("")}}),$(t._container).find(".empty").on("click",function(){t._editor.document.body.innerHTML=""}),$(t._container).find(".link").hover(function(){var e="";$(".J_edit_item_references").find(".J_references_item").each(function(t,i){e+='<button class="link-item" data-link="'+$(this).find(".J_url").text()+'">'+$(this).find(".J_title").text()+"<br>"+$(this).find(".J_url").text()+"</button>"}),$(t._container).find(".link-item-content").html(e),$(t._container).find(".link-content").show()},function(){$(t._container).find(".link-content").hide()}),$(t._container).find(".link-content").hover(function(){$(this).show()},function(){$(this).hide()}),$(this._editor.document).off("mouseover").on("mouseover",".link-flag",function(){var t=$(this).find("img").data("html");$(this).find(".link-tips-content").html(t),$(this).find(".link-tips").show()}),$(this._editor.document).on("mouseout",".link-flag",function(){$(this).find(".link-tips").hide()}),$(t._container).on("click",".link-item",function(){var e=$(this).html();$(this).data("link");t.insertImage('<span class="link-flag"><img class="img-link" data-html="'+e+'" src="'+$GC.staticServer+'/baike/img/baike/editor/icon.png"><span class="link-tips"><i class="arrow-top"></i><i class="arrow-bottom"></i><span class="link-tips-content"></span></span></span>&nbsp;&nbsp;'),$(this).parents(".link-content").hide()})},t.prototype.insertImage=function(t){$.trim($(this._editor.document.body).html())===this.options.placeholder&&$(this._editor.document.body).html(""),this._editor.focus();var e=this._editor.getSelection?this._editor.getSelection():this._editor.document.selection,i=e.createRange?e.createRange():e.getRangeAt(0);if(this._editor.getSelection){i.collapse(!1);for(var o=i.createContextualFragment(t),n=o.lastChild;n&&"br"==n.nodeName.toLowerCase()&&n.previousSibling&&"br"==n.previousSibling.nodeName.toLowerCase();){var a=n;n=n.previousSibling,o.removeChild(a)}i.insertNode(i.createContextualFragment(t)),n&&(i.setEndAfter(n),i.setStartAfter(n))}else i.pasteHTML(t),i.collapse(!1),i.select()},t.prototype.getValue=function(){var t=$.trim($(this._editor.document.body).html());return t===this.options.placeholder||""===$.trim(t.replace(/&nbsp;/g," "))?"":String(this._editor.document.body.innerHTML).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")},t.prototype.setValue=function(t){""===$.trim(t)&&(t=""),this._editor.document.body.innerHTML=t},t});